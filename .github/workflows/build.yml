name: Build Releases

on:
  push:
    branches: [ master ]
    tags: [ '*' ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Build Docker image for AppImage
        run: |
          docker build -t electrum-appimage-builder contrib/build-linux/appimage/

      - name: Build AppImage
        run: |
          docker run --rm -v "$PWD:/electrum" electrum-appimage-builder bash -c "cd /electrum/contrib/build-linux/appimage && bash build.sh"

      - name: Rename AppImage
        run: |
          cd dist
          for f in electrum-*.AppImage; do
            mv "$f" "lbry-vault-${f#electrum-}"
          done

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: dist/*.AppImage

  build-windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Build Docker image for Wine
        run: |
          docker build -t electrum-wine-builder contrib/build-wine/

      - name: Build Windows executables
        run: |
          docker run --rm -v "$PWD:/opt/wine64/drive_c/electrum" -w /opt/wine64/drive_c/electrum/contrib/build-wine electrum-wine-builder ./build.sh

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-executables
          path: |
            contrib/build-wine/dist/*.exe
            !contrib/build-wine/dist/electrum/*.exe

  build-macos:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          brew install automake autoconf libtool gettext coreutils

      - name: Set up Python 3.7
        run: |
          brew install pyenv
          eval "$(pyenv init -)"
          PYTHON_CONFIGURE_OPTS="--enable-framework" pyenv install -s 3.7.17
          pyenv global 3.7.17
          echo "$HOME/.pyenv/shims" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: |
          eval "$(pyenv init -)"
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install --no-dependencies -r contrib/deterministic-build/requirements-binaries.txt
          python3 -m pip install pyinstaller==3.6

      - name: Build libsecp256k1
        run: |
          eval "$(pyenv init -)"
          contrib/make_libsecp256k1.sh

      - name: Download libusb
        run: |
          mkdir -p /tmp/electrum-build
          curl -L https://github.com/libusb/libusb/releases/download/v1.0.26/libusb-1.0.26.tar.bz2 | tar xj -C /tmp/electrum-build
          cd /tmp/electrum-build/libusb-1.0.26
          ./configure --prefix=/tmp/libusb-install
          make -j4
          make install
          cp /tmp/libusb-install/lib/libusb-1.0.dylib contrib/osx/
          cp /tmp/libusb-install/lib/libusb-1.0.0.dylib contrib/osx/ || true

      - name: Generate locale
        run: |
          cd contrib/deterministic-build/electrum-locale
          for i in ./locale/*; do
            dir="$GITHUB_WORKSPACE/electrum/$i/LC_MESSAGES"
            mkdir -p "$dir"
            msgfmt --output-file="$dir/electrum.mo" "$i/electrum.po" || true
          done

      - name: Install application dependencies
        run: |
          eval "$(pyenv init -)"
          python3 -m pip install --no-dependencies -r contrib/deterministic-build/requirements.txt
          python3 -m pip install --no-dependencies -r contrib/deterministic-build/requirements-hw.txt
          python3 -m pip install --no-dependencies .

      - name: Build macOS app
        run: |
          eval "$(pyenv init -)"
          VERSION=$(git describe --tags --dirty --always)
          pyinstaller --noconfirm --ascii --clean --name "$VERSION" contrib/osx/osx.spec

      - name: Create DMG
        run: |
          VERSION=$(git describe --tags --dirty --always)
          # Rename app bundle
          mv dist/Electrum.app dist/LBRY-Vault.app 2>/dev/null || true
          mv "dist/${VERSION}.app" dist/LBRY-Vault.app 2>/dev/null || true
          # Create DMG
          hdiutil create -fs HFS+ -volname "LBRY-Vault" -srcfolder dist/LBRY-Vault.app "dist/lbry-vault-${VERSION}.dmg"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/linux-appimage/*
            artifacts/windows-executables/*
            artifacts/macos-dmg/*
          draft: true
          generate_release_notes: true
